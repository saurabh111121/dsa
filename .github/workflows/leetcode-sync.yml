name: Sync LeetCode

on:
  workflow_dispatch:  # Allow manual triggering
  schedule:
    - cron: "0 0 * * *"  # Run daily at midnight UTC (5:30 AM IST)

jobs:
  sync-leetcode:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Sync LeetCode Solutions
        uses: joshcai/leetcode-sync@v1.7
        with:
          github-token: ${{ github.token }}
          leetcode-csrf-token: ${{ secrets.LEETCODE_CSRF_TOKEN }}
          leetcode-session: ${{ secrets.LEETCODE_SESSION }}
          destination-folder: src/com/leetcode/solutions
          verbose: true
          commit-header: "[LeetCode Sync]"
          
      # Copy newest solutions to daily challenge folder if submitted today
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 2
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
          
      - name: Extract today's solutions to daily challenge directory
        run: |
          python - <<EOF
          import os
          import shutil
          from datetime import datetime
          
          # Get today's date
          today = datetime.now().strftime('%Y-%m-%d')
          
          # Create daily challenge directory
          daily_dir = f"src/com/leetcode/daily_challenge/{today}"
          os.makedirs(daily_dir, exist_ok=True)
          
          # Get list of files modified in the last commit
          recent_solutions = []
          solutions_dir = "src/com/leetcode/solutions"
          
          # Only proceed if solutions directory exists
          if os.path.exists(solutions_dir):
              for root, dirs, files in os.walk(solutions_dir):
                  for file in files:
                      # Only copy Java files
                      if file.endswith('.java'):
                          src_file = os.path.join(root, file)
                          dest_file = os.path.join(daily_dir, file)
                          
                          # Copy the file to daily challenge directory
                          shutil.copy2(src_file, dest_file)
                          print(f"Copied {src_file} to {dest_file}")
                          
                          # If there's a README, copy it too
                          readme_src = os.path.join(root, "README.md")
                          if os.path.exists(readme_src):
                              readme_dest = os.path.join(daily_dir, "README.md")
                              shutil.copy2(readme_src, readme_dest)
                              print(f"Copied {readme_src} to {readme_dest}")
          EOF
          
      - name: Commit daily challenge files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add src/com/leetcode/daily_challenge/
          
          # Commit only if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "[LeetCode Sync] Update daily challenge folder" && git push)
